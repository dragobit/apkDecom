name: Scene Detection

on:
  workflow_dispatch:
    inputs:
      video_url:
        description: 'Video URL (YouTube/HLS/HTTP/â€¦)'
        required: true

jobs:
  detect:
    runs-on: ubuntu-latest
    steps:
      - name: Install dependencies
        run: |
          pip install "yt-dlp[default,curl-cffi]" 
          pip install scenedetect[opencv]
          sudo apt-get update 
          sudo apt-get install -y ffmpeg
      
      - name: Download video
        run: |
          mkdir -p videos
          yt-dlp -f best -o "videos/${{ github.run_number }}.%(ext)s" "${{ github.event.inputs.video_url }}" --extractor-args "generic:impersonate"
          ls -lh videos/
      
      - name: Select video file
        id: select_video
        run: |
          VIDEO=$(ls -1 videos/* | head -1)
          echo "VIDEO=$VIDEO" >> $GITHUB_ENV
          
          
      
      - name: Scene detection
        run: |
          mkdir -p results

          IFS=',' read -r VIDEO_WIDTH VIDEO_HEIGHT <<< $(ffprobe -v error -select_streams v -show_entries stream=width,height -of csv=p=0:s=, "${{ env.VIDEO }}")
          echo "VIDEO_HEIGHT=$VIDEO_HEIGHT" >> $GITHUB_ENV
          echo "VIDEO_WIDTH=$VIDEO_WIDTH" >> $GITHUB_ENV
             
          cat > scenedetect.conf << EOF
          [global]
          output = results
          default-detector = detect-adaptive
          [detect-adaptive]
          threshold = 3
          [export-html]
          image-height = $VIDEO_HEIGHT
          image-width = $VIDEO_WIDTH
          EOF
          
          scenedetect -i "${{ env.VIDEO }}" -v debug -c scenedetect.conf save-html 
          ls -lh results/
      
      - name: Upload results
        uses: actions/upload-artifact@v4
        with:
          name: results
          path: results/
          retention-days: 7
