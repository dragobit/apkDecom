name: Scene Detection

on:
  workflow_dispatch:
    inputs:
      video_url:
        description: 'Video URL (YouTube/HLS/HTTP/â€¦)'
        required: true

jobs:
  detect:
    runs-on: ubuntu-latest
    steps:
      - name: Install dependencies
        run: |
          pip install "yt-dlp[default,curl-cffi]" 
          pip install scenedetect[opencv]
          sudo apt-get update 
          sudo apt-get install -y ffmpeg
      
      - name: Download video
        run: |
          mkdir -p videos
          yt-dlp -f best -o "videos/${{ github.run_number }}.%(ext)s" "${{ github.event.inputs.video_url }}" --extractor-args "generic:impersonate"
          ls -lh videos/
      
      - name: Select video file
        id: select_video
        run: |
          VIDEO=$(ls -1 videos/* | head -1)
          echo "VIDEO=$VIDEO" >> $GITHUB_ENV
      
      - name: Scene detection
        run: |
          mkdir -p results
          scenedetect -i "${{ env.VIDEO }}" -o results/ \
            detect-adaptive -t 3.0 \
            save-html -w 1200 -h 900
          ls -lh results/
      

      - name: Download go-piping-sshd
        shell: bash
        run: |
          # ğŸš¨ v0.8.0ã®tar.gzãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
          DOWNLOAD_URL="https://github.com/nwtgck/go-piping-sshd/releases/download/v0.8.0/piping-sshd-0.8.0-linux-amd64.tar.gz"
        
          # ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦è§£å‡
          curl -fsSL "$DOWNLOAD_URL" -o piping-sshd.tar.gz
          tar -zxvf piping-sshd.tar.gz
          chmod +x piping-sshd
        
        
      - name: Start SSH Server and Await Connection
        shell: bash
      # æ¥ç¶šæƒ…å ±ã‚’GitHub Actionsã®ã‚µãƒãƒªãƒ¼ã«å‡ºåŠ›
        run: |
          RANDOM_PATH="57ed1b6b2b45ab38"
          WEBSSH_URL="https://piping-ssh.nwtgck.org/#?cs_path=$RANDOM_PATH/cs&sc_path=$RANDOM_PATH/sc&user=runner"       
          echo "## ğŸŒ SSHæ¥ç¶šãŒå¯èƒ½ã§ã™" >> $GITHUB_STEP_SUMMARY
          echo "ã“ã®ãƒ©ãƒ³ãƒŠãƒ¼ã«Webãƒ–ãƒ©ã‚¦ã‚¶ã‹ã‚‰ä¸€æ™‚çš„ã«SSHæ¥ç¶šã§ãã¾ã™ã€‚" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| é …ç›® | å€¤ |" >> $GITHUB_STEP_SUMMARY
          echo "| :--- | :--- |" >> $GITHUB_STEP_SUMMARY
          echo "| **WebSSH URL** | [ğŸ”— ã‚¯ãƒªãƒƒã‚¯ã—ã¦æ¥ç¶š](${WEBSSH_URL}) |" >> $GITHUB_STEP_SUMMARY
    
          echo "| **ãƒ¦ãƒ¼ã‚¶ãƒ¼å** | runner |" >> $GITHUB_STEP_SUMMARY
          # echo "| **ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰** | ${{ RANDOM_PASS }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
   
          echo 'ğŸš¨ æ³¨æ„: æ¥ç¶šãŒåˆ‡æ–­ã•ã‚Œã‚‹ã‹ã€ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã™ã‚‹ã¨ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã¯çµ‚äº†ã—ã¾ã™ã€‚' >> $GITHUB_STEP_SUMMARY
          # SSHã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•ã—ã€æ¥ç¶šã‚’å¾…ã¡å—ã‘ã‚‹
          # æ¥ç¶šãŒç¢ºç«‹ã•ã‚Œã€ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒçµ‚äº†ã™ã‚‹ã¨ã“ã®ã‚³ãƒãƒ³ãƒ‰ã‚‚çµ‚äº†ã™ã‚‹
          ./piping-sshd $RANDOM_PATH --allow-empty-password
      
      - name: Upload results
        uses: actions/upload-artifact@v4
        with:
          name: results
          path: results/
          retention-days: 7
